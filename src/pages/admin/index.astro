---
import { sessionManager } from "@/auth";
import { getSessionCookieConfig } from "@/auth/session";
import { validateCsrfToken } from "@/auth/csrf";
import { getAllUnits } from "@/data/repo/unit-repository";

const session = Astro.locals.session!;

if (Astro.request.method === "POST") {
  const data = await Astro.request.formData();
  const action = data.get("action")?.toString();
  const submittedCsrf = data.get("_csrf")?.toString() ?? "";

  if (action === "logout" && validateCsrfToken(session.csrfToken, submittedCsrf)) {
    sessionManager.destroySession(session.sessionId);
    const cookieConfig = getSessionCookieConfig(import.meta.env.PROD);
    Astro.cookies.delete(cookieConfig.name, { path: cookieConfig.path });
    return Astro.redirect("/admin/login");
  }
}

const units = getAllUnits();
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="stylesheet" href="/styles.css" />
    <title>Admin Dashboard - aine-program</title>
  </head>
  <body>
    <header>
      <p>Logged in as <strong>{session.username}</strong></p>
      <form method="POST" style="display:inline">
        <input type="hidden" name="_csrf" value={session.csrfToken} />
        <input type="hidden" name="action" value="logout" />
        <button type="submit">Log Out</button>
      </form>
    </header>
    <main class="page">
      <h1>Admin Dashboard</h1>

      <section>
        <h2>Units</h2>
        <p><a href="/admin/units/new">Create New Unit</a></p>

        {units.length === 0 ? (
          <p>No units yet. <a href="/admin/units/new">Create one now.</a></p>
        ) : (
          <ul>
            {units.map((u) => (
              <li>
                <a href={`/admin/units/${u.id}/edit`}>{u.name}</a>
              </li>
            ))}
          </ul>
        )}
      </section>
    </main>
  </body>
</html>
