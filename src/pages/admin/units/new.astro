---
import { UnitForm } from "@/form/UnitForm";
import { validateCsrfToken } from "@/auth/csrf";

const session = Astro.locals.session!;
const csrfToken = session.csrfToken;

const unitForm = new UnitForm();

if (Astro.request.method === "POST") {
  const data = await Astro.request.formData();
  const submittedCsrf = data.get("_csrf")?.toString() ?? "";

  if (!validateCsrfToken(csrfToken, submittedCsrf)) {
    unitForm.getErrors().form = "Invalid form submission. Please try again.";
  } else if (unitForm.handleForm(data)) {
    return Astro.redirect("/admin");
  }
}

const fields = unitForm.getFields();
const errors = unitForm.getErrors();
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="stylesheet" href="/styles.css" />
    <title>Create New Unit - Admin - aine-program</title>
  </head>
  <body>
    <main class="page">
      <h1>Create New Unit</h1>

      <p><a href="/admin">&larr; Back to Dashboard</a></p>

      {errors.form && <p class="admin-form__error" role="alert">{errors.form}</p>}

      <form method="POST">
        <input type="hidden" name="_csrf" value={csrfToken} />

        {fields.map((field) => (
          <div class="admin-form__field">
            <label for={field.name} class="admin-form__label">
              {field.label}{field.required && " *"}
            </label>
            <input
              id={field.name}
              name={field.name}
              type={field.type}
              class="admin-form__input"
              value={field.value ?? ""}
              aria-describedby={errors[field.name] ? `${field.name}-error` : undefined}
            />
            {errors[field.name] && (
              <p id={`${field.name}-error`} class="admin-form__error">
                {errors[field.name]}
              </p>
            )}
          </div>
        ))}

        <div class="admin-form__field">
          <label for="description" class="admin-form__label">Description</label>
          <textarea
            id="description"
            name="description"
            rows="4"
            class="admin-form__textarea"
            aria-describedby={errors.description ? "description-error" : undefined}
          >{unitForm.getValue("description") ?? ""}</textarea>
          {errors.description && (
            <p id="description-error" class="admin-form__error">{errors.description}</p>
          )}
        </div>

        <div class="admin-form__field">
          <label for="keywords" class="admin-form__label">Keywords</label>
          <input
            id="keywords"
            name="keywords"
            class="admin-form__input"
            value={unitForm.getValue("keywords") ?? ""}
            placeholder="e.g. Infantry, Imperium, Adeptus Astartes"
            aria-describedby={errors.keywords ? "keywords-error" : undefined}
          />
          {errors.keywords && (
            <p id="keywords-error" class="admin-form__error">{errors.keywords}</p>
          )}
        </div>

        <button type="submit" class="admin-form__submit">Create Unit</button>
      </form>
    </main>
  </body>
</html>
