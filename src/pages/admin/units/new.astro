---
import type { FormField } from "../../../form/field";
import { validateCsrfToken } from "../../../auth/csrf";
import { unitSchema } from "../../../data/validation/unit";
import { slugify } from "../../../data/orm/slugify";
import { createUnit, isSlugAvailable } from "../../../data/repo/unit-repository";

const session = Astro.locals.session!;
const csrfToken = session.csrfToken;

let errors: Record<string, string> = {};
let formData: Record<string, string> = {};

if (Astro.request.method === "POST") {
  const data = await Astro.request.formData();
  const submittedCsrf = data.get("_csrf")?.toString() ?? "";

  if (!validateCsrfToken(csrfToken, submittedCsrf)) {
    errors.form = "Invalid form submission. Please try again.";
  } else {
    const raw = {
      name: data.get("name")?.toString() ?? "",
      movement: data.get("movement")?.toString() ?? "",
      toughness: data.get("toughness")?.toString() ?? "",
      save: data.get("save")?.toString() ?? "",
      wounds: data.get("wounds")?.toString() ?? "",
      leadership: data.get("leadership")?.toString() ?? "",
      objectiveControl: data.get("objectiveControl")?.toString() ?? "",
      invulnerabilitySave: data.get("invulnerabilitySave")?.toString() ?? "",
      description: data.get("description")?.toString() ?? "",
      keywords: data.get("keywords")?.toString() ?? "",
    };

    formData = raw;

    const parsed = unitSchema.safeParse(raw);

    if (!parsed.success) {
      for (const issue of parsed.error.issues) {
        const field = issue.path[0]?.toString();
        if (field && !errors[field]) {
          errors[field] = issue.message;
        }
      }
    } else {
      const slug = slugify(parsed.data.name);

      if (!isSlugAvailable(slug)) {
        errors.name = "A unit with a similar name already exists. Please choose a different name.";
      } else {
        createUnit({
          ...parsed.data,
          slug,
        });
        return Astro.redirect("/admin");
      }
    }
  }
}

const fields: Array<FormField> = [
  { name: "name", label: "Name", required: true, type: "text" },
  { name: "movement", label: "Movement", required: true, type: "number" },
  { name: "toughness", label: "Toughness", required: true, type: "number" },
  { name: "save", label: "Save", required: true, type: "number" },
  { name: "wounds", label: "Wounds", required: true, type: "number" },
  { name: "leadership", label: "Leadership", required: true, type: "text" },
  { name: "objectiveControl", label: "Objective Control", required: true, type: "number" },
  { name: "invulnerabilitySave", label: "Invulnerability Save", required: true, type: "number" },
];
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="stylesheet" href="/styles.css" />
    <title>Create New Unit - Admin - aine-program</title>
  </head>
  <body>
    <main class="page">
      <h1>Create New Unit</h1>

      <p><a href="/admin">&larr; Back to Dashboard</a></p>

      {errors.form && <p class="admin-form__error" role="alert">{errors.form}</p>}

      <form method="POST">
        <input type="hidden" name="_csrf" value={csrfToken} />

        {fields.map((field) => (
          <div class="admin-form__field">
            <label for={field.name} class="admin-form__label">
              {field.label}{field.required && " *"}
            </label>
            <input
              id={field.name}
              name={field.name}
              type={field.type}
              class="admin-form__input"
              value={formData[field.name] ?? ""}
              aria-describedby={errors[field.name] ? `${field.name}-error` : undefined}
            />
            {errors[field.name] && (
              <p id={`${field.name}-error`} class="admin-form__error">
                {errors[field.name]}
              </p>
            )}
          </div>
        ))}

        <div class="admin-form__field">
          <label for="description" class="admin-form__label">Description</label>
          <textarea
            id="description"
            name="description"
            rows="4"
            class="admin-form__textarea"
            aria-describedby={errors.description ? "description-error" : undefined}
          >{formData.description ?? ""}</textarea>
          {errors.description && (
            <p id="description-error" class="admin-form__error">{errors.description}</p>
          )}
        </div>

        <div class="admin-form__field">
          <label for="keywords" class="admin-form__label">Keywords</label>
          <input
            id="keywords"
            name="keywords"
            class="admin-form__input"
            value={formData.keywords ?? ""}
            placeholder="e.g. Infantry, Imperium, Adeptus Astartes"
            aria-describedby={errors.keywords ? "keywords-error" : undefined}
          />
          {errors.keywords && (
            <p id="keywords-error" class="admin-form__error">{errors.keywords}</p>
          )}
        </div>

        <button type="submit" class="admin-form__submit">Create Unit</button>
      </form>
    </main>
  </body>
</html>
