---
import { UnitForm } from "@/form/UnitForm";
import { validateCsrfToken } from "@/auth/csrf";
import UnitAdminForm from "@/components/UnitAdminForm.astro";

const session = Astro.locals.session!;
const csrfToken = session.csrfToken;

const unitForm = new UnitForm();

if (Astro.request.method === "POST") {
  const data = await Astro.request.formData();
  const submittedCsrf = data.get("_csrf")?.toString() ?? "";

  if (!validateCsrfToken(csrfToken, submittedCsrf)) {
    unitForm.getErrors().form = "Invalid form submission. Please try again.";
  } else if (unitForm.handleForm(data)) {
    return Astro.redirect("/admin");
  }
}
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="stylesheet" href="/styles.css" />
    <title>Create New Unit - Admin - aine-program</title>
  </head>
  <body>
    <main class="page">
      <h1>Create New Unit</h1>

      <p><a href="/admin">&larr; Back to Dashboard</a></p>

      <UnitAdminForm
        csrfToken={csrfToken}
        unitForm={unitForm}
        submitLabel="Create Unit"
      />

      <p><em>Save the unit first, then add models from the edit page.</em></p>
    </main>
  </body>
</html>
