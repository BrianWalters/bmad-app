---
import { ModelForm } from "@/form/ModelForm";
import { validateCsrfToken } from "@/auth/csrf";
import { getUnitById } from "@/data/repo/unit-repository";
import { deleteModelById } from "@/data/repo/model-repository";
import { getEquipmentOptionsForModel, getEquipmentOptionById, setDefaultEquipment, unsetDefaultEquipment, getUnassociatedEquipmentOptions, associateEquipmentOptionWithModel, isEquipmentOptionAssociatedWithModel } from "@/data/repo/equipment-option-repository";
import ModelAdminForm from "@/components/ModelAdminForm.astro";
import Button from "@/components/Button.astro";
import EquipmentOptionsSelect from "@/components/EquipmentOptionsSelect.astro";

const session = Astro.locals.session!;
const csrfToken = session.csrfToken;

const id = Number(Astro.params.unitId);
const modelId = Number(Astro.params.modelId);
if (isNaN(id) || isNaN(modelId)) {
  return new Response(null, { status: 404 });
}

const unit = getUnitById(id);
if (!unit) {
  return new Response(null, { status: 404 });
}

const modelForm = new ModelForm(id, modelId);

if (!modelForm.exists()) {
  return new Response(null, { status: 404 });
}

if (Astro.request.method === "POST") {
  const data = await Astro.request.formData();
  const submittedCsrf = data.get("_csrf")?.toString() ?? "";

  if (!validateCsrfToken(csrfToken, submittedCsrf)) {
    modelForm.getErrors().form = "Invalid form submission. Please try again.";
  } else if (data.get("action") === "delete") {
    deleteModelById(modelId);
    return Astro.redirect(`/admin/units/${id}/edit`);
  } else if (data.get("action") === "set-default") {
    const equipmentId = Number(data.get("equipmentId"));
    if (!isNaN(equipmentId)) {
      setDefaultEquipment(modelId, equipmentId);
    }
    return Astro.redirect(`/admin/units/${id}/models/${modelId}/edit`);
  } else if (data.get("action") === "add-existing") {
    const equipmentId = Number(data.get("equipmentId"));
    if (!isNaN(equipmentId) && equipmentId > 0 && getEquipmentOptionById(equipmentId) && !isEquipmentOptionAssociatedWithModel(modelId, equipmentId)) {
      associateEquipmentOptionWithModel(modelId, equipmentId);
    }
    return Astro.redirect(`/admin/units/${id}/models/${modelId}/edit`);
  } else if (data.get("action") === "unset-default") {
    const equipmentId = Number(data.get("equipmentId"));
    if (!isNaN(equipmentId)) {
      unsetDefaultEquipment(modelId, equipmentId);
    }
    return Astro.redirect(`/admin/units/${id}/models/${modelId}/edit`);
  } else if (modelForm.handleForm(data)) {
    return Astro.redirect(`/admin/units/${id}/edit`);
  }
}

const modelName = modelForm.getValue("name") ?? "Model";
const equipmentOptions = getEquipmentOptionsForModel(modelId);
const hasDefault = equipmentOptions.some((o) => o.isDefault === 1);
const unassociatedOptions = getUnassociatedEquipmentOptions(modelId);
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="stylesheet" href="/styles.css" />
    <title>Edit {modelName} - {unit.name} - Admin - aine-program</title>
  </head>
  <body>
    <main class="page">
      <h1>Edit {modelName}</h1>

      <p><a href={`/admin/units/${id}/edit`}>&larr; Back to {unit.name}</a></p>

      <ModelAdminForm
        csrfToken={csrfToken}
        modelForm={modelForm}
        submitLabel="Save Changes"
      />

      <hr />

      <form method="POST" onsubmit="return confirm('Are you sure you want to delete this model? This action cannot be undone.')">
        <input type="hidden" name="_csrf" value={csrfToken} />
        <input type="hidden" name="action" value="delete" />
        <Button type="submit" label="Delete Model" variant="danger" />
      </form>

      <hr />

      <section>
        <h2>Equipment Options</h2>

        {equipmentOptions.length === 0 ? (
          <p><em>No equipment options yet.</em></p>
        ) : (
          <>
            {!hasDefault && <p><em>No defaults selected.</em></p>}
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Range</th>
                  <th>A</th>
                  <th>BS/WS</th>
                  <th>S</th>
                  <th>AP</th>
                  <th>D</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {equipmentOptions.map((option) => (
                  <tr>
                    <td>
                      {option.name}
                      {option.isDefault === 1 && " (Default)"}
                    </td>
                    <td>{option.range}</td>
                    <td>{option.attacks}</td>
                    <td>{option.skill}</td>
                    <td>{option.strength}</td>
                    <td>{option.armorPiercing}</td>
                    <td>{option.damageMin}â€“{option.damageMax}</td>
                    <td>
                      <a href={`/admin/units/${id}/models/${modelId}/equipment/${option.id}/edit`}>Edit</a>
                      <form method="POST" class="admin-form--inline">
                        <input type="hidden" name="_csrf" value={csrfToken} />
                        <input type="hidden" name="action" value={option.isDefault === 1 ? "unset-default" : "set-default"} />
                        <input type="hidden" name="equipmentId" value={option.id} />
                        <button type="submit" aria-label={option.isDefault === 1 ? `Unset Default for ${option.name}` : `Set ${option.name} as Default`}>{option.isDefault === 1 ? "Unset Default" : "Set as Default"}</button>
                      </form>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </>
        )}

        <p><a href={`/admin/units/${id}/models/${modelId}/equipment/new`}>Create New Equipment Option</a></p>

        <EquipmentOptionsSelect csrfToken={csrfToken} options={unassociatedOptions} />
      </section>
    </main>
  </body>
</html>
