---
import { UnitForm } from "@/form/UnitForm";
import { validateCsrfToken } from "@/auth/csrf";
import { deleteUnitById } from "@/data/repo/unit-repository";
import { getModelsForUnit } from "@/data/repo/model-repository";
import { getEquipmentOptionSummaryForModel } from "@/data/repo/equipment-option-repository";
import UnitAdminForm from "@/components/UnitAdminForm.astro";
import Button from "@/components/Button.astro";

const session = Astro.locals.session!;
const csrfToken = session.csrfToken;

const id = Number(Astro.params.unitId);
if (isNaN(id)) {
  return new Response(null, { status: 404 });
}

const unitForm = new UnitForm(id);

if (!unitForm.exists()) {
  return new Response(null, { status: 404 });
}

if (Astro.request.method === "POST") {
  const data = await Astro.request.formData();
  const submittedCsrf = data.get("_csrf")?.toString() ?? "";

  if (!validateCsrfToken(csrfToken, submittedCsrf)) {
    unitForm.getErrors().form = "Invalid form submission. Please try again.";
  } else if (data.get("action") === "delete") {
    deleteUnitById(id);
    return Astro.redirect("/admin");
  } else if (unitForm.handleForm(data)) {
    return Astro.redirect("/admin");
  }
}

const unitName = unitForm.getValue("name") ?? "Unit";
const models = getModelsForUnit(id);
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="stylesheet" href="/styles.css" />
    <title>Edit {unitName} - Admin - aine-program</title>
  </head>
  <body>
    <main class="page">
      <h1>Edit {unitName}</h1>

      <p><a href="/admin">&larr; Back to Dashboard</a></p>

      <UnitAdminForm
        csrfToken={csrfToken}
        unitForm={unitForm}
        submitLabel="Save Changes"
      />

      <hr />

      <form method="POST" onsubmit="return confirm('Are you sure you want to delete this unit? This action cannot be undone.')">
        <input type="hidden" name="_csrf" value={csrfToken} />
        <input type="hidden" name="action" value="delete" />
        <Button type="submit" label="Delete Unit" variant="danger" />
      </form>

      <hr />

      <section>
        <h2>Models</h2>
        {models.length === 0 ? (
          <p>No models yet.</p>
        ) : (
          <ol>
            {models.map((m) => {
              const summary = getEquipmentOptionSummaryForModel(m.id);
              return (
                <li>
                  {m.name} ({summary.total} equipment option{summary.total !== 1 && "s"}{summary.defaultNames.length > 0 && `, defaults: ${summary.defaultNames.join(", ")}`})
                  â€” <a href={`/admin/units/${id}/models/${m.id}/edit`}>Edit</a>
                </li>
              );
            })}
          </ol>
        )}
        <p><a href={`/admin/units/${id}/models/new`}>Add Model</a></p>
      </section>
    </main>
  </body>
</html>
