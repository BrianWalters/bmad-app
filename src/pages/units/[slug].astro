---
import Base from "@/layouts/Base.astro";
import Breadcrumb from "@/components/Breadcrumb.astro";
import { getFullUnitBySlug } from "@/data/repo/unit-repository";
import { UnitPresenter } from "@/presenters/UnitPresenter";
import "./UnitDetail.css";

const { slug } = Astro.params;

const data = getFullUnitBySlug(slug!);
if (!data) {
  return new Response(null, { status: 404 });
}

const presenter = new UnitPresenter(data);
const { unit } = presenter;
const modelGroups = presenter.modelGroups;
---

<Base title={`${unit.name} â€” Army Builder`} description={unit.description ?? undefined}>
  <Breadcrumb items={[{ label: "Home", href: "/" }, { label: unit.name }]} />

  <h1>{unit.name}</h1>

  {presenter.unit.keywords.length > 0 && (
    <p class="unit-detail__keywords">{presenter.formattedKeywords}</p>
  )}

  <dl class="unit-detail__attributes">
    <div>
      <dt>Movement</dt>
      <dd>{unit.movement}"</dd>
    </div>
    <div>
      <dt>Toughness</dt>
      <dd>{unit.toughness}</dd>
    </div>
    <div>
      <dt>Save</dt>
      <dd>{unit.save}+</dd>
    </div>
    <div>
      <dt>Wounds</dt>
      <dd>{unit.wounds}</dd>
    </div>
    <div>
      <dt>Leadership</dt>
      <dd>{unit.leadership}+</dd>
    </div>
    <div>
      <dt>Objective Control</dt>
      <dd>{unit.objectiveControl}</dd>
    </div>
    {unit.invulnerabilitySave !== null && (
      <div>
        <dt>Invulnerability Save</dt>
        <dd>{unit.invulnerabilitySave}+</dd>
      </div>
    )}
  </dl>

  {unit.description && (
    <details>
      <summary>Description</summary>
      <p>{unit.description}</p>
    </details>
  )}

  <h2>Models</h2>

  {modelGroups.map((group) => {
    const ranged = group.equipment.filter((e) => e.range > 0);
    const melee = group.equipment.filter((e) => e.range === 0);
    const heading = group.count > 1 ? `${group.count} ${group.name}` : group.name;

    return (
      <section class="unit-detail__model">
        <h3>{heading}</h3>

        {ranged.length > 0 && (
          <>
            <h4>Ranged Weapons</h4>
            <div class="table-scroll">
              <table>
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Range</th>
                    <th>A</th>
                    <th>BS</th>
                    <th>S</th>
                    <th>AP</th>
                    <th>D</th>
                  </tr>
                </thead>
                <tbody>
                  {ranged.map((eq) => (
                    <tr class={eq.isDefault ? "unit-detail__equipment--default" : ""}>
                      <td>{eq.name}{eq.isDefault ? " (Default)" : ""}</td>
                      <td>{eq.range}"</td>
                      <td>{eq.attacks}</td>
                      <td>{eq.skill}+</td>
                      <td>{eq.strength}</td>
                      <td>{presenter.formatAP(eq.armorPiercing)}</td>
                      <td>{presenter.formatDamage(eq.damageMin, eq.damageMax)}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </>
        )}

        {melee.length > 0 && (
          <>
            <h4>Melee Weapons</h4>
            <div class="table-scroll">
              <table>
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>A</th>
                    <th>WS</th>
                    <th>S</th>
                    <th>AP</th>
                    <th>D</th>
                  </tr>
                </thead>
                <tbody>
                  {melee.map((eq) => (
                    <tr class={eq.isDefault ? "unit-detail__equipment--default" : ""}>
                      <td>{eq.name}{eq.isDefault ? " (Default)" : ""}</td>
                      <td>{eq.attacks}</td>
                      <td>{eq.skill}+</td>
                      <td>{eq.strength}</td>
                      <td>{presenter.formatAP(eq.armorPiercing)}</td>
                      <td>{presenter.formatDamage(eq.damageMin, eq.damageMax)}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </>
        )}

        {ranged.length === 0 && melee.length === 0 && (
          <p class="unit-detail__no-equipment">No equipment options</p>
        )}
      </section>
    );
  })}
</Base>
